<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âš¡ POKEMON: MOBILE MASTER EDITION âš¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #050505 url('PIC1.png') no-repeat center center fixed; background-size: cover; overflow: hidden; font-family: 'Jua', sans-serif; touch-action: none; }
        .main-container { display: flex; justify-content: center; align-items: flex-start; background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(15px); border-radius: 30px; border: 2px solid rgba(255, 215, 0, 0.4); box-shadow: 0 0 80px rgba(0,0,0,1); position: relative; max-width: 95vw; }
        
        /* ê²Œì„ ë©”ì¸ ì„¹ì…˜ */
        .game-view { position: relative; width: 550px; height: 600px; background: #000; overflow: hidden; }
        canvas { display: block; width: 550px; height: 600px; cursor: default; } 

        /* [ì¶”ê°€] ëª¨ë°”ì¼ ì¡°ì‘íŒ¨ë“œ ìŠ¤íƒ€ì¼ */
        .mobile-ui { position: absolute; bottom: 20px; width: 100%; display: none; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; z-index: 1500; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 50px); grid-template-rows: repeat(3, 50px); gap: 5px; pointer-events: auto; }
        .btn-m { width: 50px; height: 50px; background: rgba(255, 215, 0, 0.2); border: 2px solid rgba(255, 215, 0, 0.5); border-radius: 12px; color: gold; display: flex; justify-content: center; align-items: center; font-size: 20px; -webkit-user-select: none; }
        .fire-btn { width: 80px; height: 80px; background: rgba(255, 215, 0, 0.3); border: 3px solid gold; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 30px; pointer-events: auto; box-shadow: 0 0 15px gold; -webkit-user-select: none; margin-top: 30px; }
        
        /* ëª¨ë°”ì¼ ì ‘ì† ì‹œ(í„°ì¹˜ ê°€ëŠ¥ ê¸°ê¸°) ì¡°ì‘íŒ¨ë“œ í‘œì‹œ */
        @media (pointer: coarse) { .mobile-ui { display: flex; } }

        /* ì‡¼ì¼€ì´ìŠ¤ ì°½ */
        .showcase-window { width: 160px; height: 600px; background: #050505; border-left: 2px solid rgba(255, 215, 0, 0.3); border-right: 2px solid rgba(255, 215, 0, 0.3); display: flex; flex-direction: column; overflow: hidden; }
        .showcase-header { color: #ffd700; text-align: center; font-family: 'Do Hyeon'; padding: 15px 0 10px 0; font-size: 18px; border-bottom: 1px solid rgba(255, 215, 0, 0.1); }
        .showcase-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; overflow-y: auto; }
        .slot { width: 40px; height: 40px; border: 1px solid rgba(255, 215, 0, 0.15); border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .slot img { width: 36px; height: 36px; image-rendering: pixelated; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 220px; height: 600px; background: rgba(5, 5, 5, 0.95); padding: 15px; display: flex; flex-direction: column; box-sizing: border-box; color: white; }
        .sidebar h2 { font-family: 'Do Hyeon', sans-serif; color: #ffd700; text-align: center; border-bottom: 2px solid rgba(255, 215, 0, 0.2); padding-bottom: 5px; margin: 0 0 10px 0; font-size: 16px; }
        .record-value { font-family: 'Do Hyeon', sans-serif; font-size: 18px; color: #ffd700; text-align: center; display: block; width: 100%; }
        .controls { margin-bottom: 10px; background: rgba(255, 215, 0, 0.03); padding: 8px; border-radius: 12px; border: 1px solid rgba(255, 215, 0, 0.1); font-size: 11px; }
        .key-row { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .key { background: #333; border: 1px solid #555; border-radius: 4px; padding: 1px 4px; color: #ffd700; font-size: 9px; }
        .bgm-info-box { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 8px; margin-bottom: 15px; }
        #mute-btn { width: 100%; background: #ffd700; border: none; border-radius: 4px; color: #000; cursor: pointer; font-family: 'Do Hyeon', sans-serif; font-size: 10px; padding: 4px; outline: none; }
        #companion-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; border-top: 1px solid #222; }
        .comp-item { display: flex; flex-direction: column; align-items: center; background: rgba(255, 215, 0, 0.05); margin: 6px 0; padding: 10px; border-radius: 12px; border: 1px solid rgba(255, 215, 0, 0.15); cursor: pointer; }
        .comp-item img { width: 60px; height: 60px; image-rendering: pixelated; }

        /* ì˜¤ë²„ë ˆì´ */
        #overlay { position: absolute; top: 0; left: 0; width: 710px; height: 100%; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; overflow: hidden; }
        #start-btn { padding: 15px 45px; font-size: 24px; cursor: pointer; background: #ffd700; border: none; border-radius: 12px; font-weight: bold; font-family: 'Do Hyeon'; box-shadow: 0 0 25px gold; position: relative; z-index: 2005; pointer-events: auto; }
        .giant-shadow { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: 500px; background: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png') no-repeat center; background-size: contain; opacity: 0.3; z-index: 1001; animation: stompGlow 0.8s ease-in-out infinite alternate; }
        @keyframes stompGlow { 0% { transform: translate(-50%, -50%) scale(1) rotate(-1deg); } 100% { transform: translate(-50%, -50%) scale(1.05) rotate(1deg); } }
    </style>
</head>
<body onclick="window.focus()">
    <div class="main-container">
        <div id="overlay">
            <div class="giant-shadow"></div>
            <div id="overlay-content" style="text-align:center; color:white; position:relative; z-index:1006;">
                <h1 style="font-family:'Do Hyeon'; font-size:55px; color:#ffd700; margin-bottom: 5px;">ìˆ²ì˜ êµ¬ì¡°ëŒ€</h1>
                <p style="color:#fff; font-size:20px; margin-bottom:25px; text-shadow: 0 0 10px gold;">151ë§ˆë¦¬ì˜ ë™ë£Œ í¬ì¼“ëª¬ì„ ì „ë¶€ êµ¬í•´ë¼!!</p>
            </div>
            <button id="start-btn" onclick="startGame()">ì‘ì „ ê°œì‹œ</button>
        </div>

        <div class="game-view">
            <canvas id="game" width="550" height="600"></canvas>
            
            <div class="mobile-ui">
                <div class="d-pad">
                    <div></div><div class="btn-m" id="m-up">â–²</div><div></div>
                    <div class="btn-m" id="m-left">â—€</div><div></div><div class="btn-m" id="m-right">â–¶</div>
                    <div></div><div class="btn-m" id="m-down">â–¼</div><div></div>
                </div>
                <div class="fire-btn" id="m-fire">âš¡</div>
            </div>

            <div style="position: absolute; top: 15px; left: 20px; color: #ffd700; font-size: 15px; font-weight: bold; pointer-events: none; text-shadow: 2px 2px #000; z-index: 10;">
                ì ìˆ˜: <span id="score-ui">0</span> | <span id="stage-ui">ìŠ¤í…Œì´ì§€ 1</span> | ê³µê²© Lv.<span id="atk-lv">1</span>
            </div>
        </div>

        <div class="showcase-window">
            <div class="showcase-header">&lt;êµ¬í•œ ë™ë£Œ&gt;</div>
            <div class="showcase-grid" id="showcase-grid"></div>
        </div>

        <div class="sidebar">
            <h2>ë‚¨ì€ ì‹œê°„</h2>
            <div style="background:rgba(255,215,0,0.05); border:1px solid #ffd700; border-radius:8px; padding:5px; margin-bottom:10px; text-align:center;"><div id="time-ui" class="record-value">05:00</div></div>
            <h2>ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <div style="background:rgba(255,215,0,0.1); border:1px solid #ffd700; border-radius:8px; padding:5px; margin-bottom:10px; text-align:center;"><div id="best-score-ui" class="record-value" style="color:#fff;">0</div></div>
            <h2>ì‹œìŠ¤í…œ ì œì–´</h2>
            <div class="controls">
                <div class="key-row"><span>ì´ë™</span> <span class="key">WASD / í„°ì¹˜</span></div>
                <div class="key-row"><span>ê³µê²©</span> <span class="key">Space / âš¡</span></div>
                <div class="key-row"><span>ì¼ì‹œì •ì§€</span> <span class="key">P í‚¤</span></div>
                <div class="key-row"><span>ìºë¦­í„° ë³€ê²½</span> <span class="key">ë™ë£Œ í´ë¦­</span></div>
                <div class="key-row"><span>ìë™ê³µê²©</span> <span class="key">Lv.7 ì´ìƒ</span></div>
            </div>
            <div class="bgm-info-box">
                <div id="bgm-display" style="font-size:10px; color:#ffd700; font-weight:bold; text-align:center; margin-bottom:4px;">ğŸµ upopoyon - ã‚¤ã‚»ãƒãƒ†ãƒ¬ã‚±</div>
                <button id="mute-btn" onclick="toggleBGM(event)">BGM ON</button>
            </div>
            <h2>êµ¬ì¡° ë„ê°</h2>
            <ul id="companion-list"></ul>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
        const listEl = document.getElementById('companion-list'), gridEl = document.getElementById('showcase-grid');
        document.getElementById('bgm-display').innerText = "ğŸµ upopoyon - \u30A4\u30BB\u30DD\u30C6\u30EC\u30B1";

        for(let i=1; i<=151; i++) { const slot = document.createElement('div'); slot.className = 'slot'; slot.id = 'slot-' + i; gridEl.appendChild(slot); }

        const pkNames = ['ì´ìƒí•´ì”¨', 'ì´ìƒí•´í’€', 'ì´ìƒí•´ê½ƒ', 'íŒŒì´ë¦¬', 'ë¦¬ìë“œ', 'ë¦¬ìëª½', 'ê¼¬ë¶€ê¸°', 'ì–´ë‹ˆë¶€ê¸°', 'ê±°ë¶ì™•', 'ìºí„°í”¼', 'ë‹¨ë°ê¸°', 'ë²„í„°í”Œ', 'ë¿”ì¶©ì´', 'ë”±ì¶©ì´', 'ë…ì¹¨ë¶•', 'êµ¬êµ¬', 'í”¼ì „', 'í”¼ì¡°íŠ¸', 'ê¼¬ë ›', 'ë ˆíŠ¸ë¼', 'ê¹¨ë¹„ì°¸', 'ê¹¨ë¹„ë“œë¦´ì¡°', 'ì•„ë³´', 'ì•„ë³´í¬', 'í”¼ì¹´ì¸„', 'ë¼ì´ì¸„', 'ëª¨ë˜ë‘ì§€', 'ê³ ì§€', 'ë‹ˆë“œëŸ°â™€', 'ë‹ˆë“œë¦¬ë‚˜', 'ë‹ˆë“œí€¸', 'ë‹ˆë“œëŸ°â™‚', 'ë‹ˆë“œë¦¬ë…¸', 'ë‹ˆë“œí‚¹', 'ì‚ì‚', 'í”½ì‹œ', 'ì‹ìŠ¤í…Œì¼', 'ë‚˜ì¸í…Œì¼', 'í‘¸ë¦°', 'í‘¸í¬ë¦°', 'ì£¼ë±ƒ', 'ê³¨ë±ƒ', 'ëšœë²…ì´ˆ', 'ëƒ„ìƒˆê¼¬', 'ë¼í”Œë ˆì‹œì•„', 'íŒŒë¼ìŠ¤', 'íŒŒë¼ì„¹íŠ¸', 'ì½˜íŒ¡', 'ë„ë‚˜ë¦¬', 'ë””ê·¸ë‹¤', 'ë‹¥íŠ¸ë¦¬ì˜¤', 'ë‚˜ì˜¹', 'í˜ë¥´ì‹œì˜¨', 'ê³ ë¼íŒŒë•', 'ê³¨ë•', 'ë§í‚¤', 'ì„±ì›ìˆ­', 'ê°€ë””', 'ìœˆë””', 'ë°œì±™ì´', 'ìŠˆë¥™ì±™ì´', 'ê°•ì±™ì´', 'ìºì´ì‹œ', 'ìœ¤ê²”ë¼', 'í›„ë”˜', 'ì•Œí†µëª¬', 'ê·¼ìœ¡ëª¬', 'ê´´ë ¥ëª¬', 'ëª¨ë‹¤í”¼', 'ìš°ì¸ ë™', 'ìš°ì¸ ë³´íŠ¸', 'ì™•ëˆˆí•´', 'ë…íŒŒë¦¬', 'ê¼¬ë§ˆëŒ', 'ë°êµ¬ë¦¬', 'ë”±êµ¬ë¦¬', 'í¬ë‹ˆíƒ€', 'ë‚ ìŒ©ë§ˆ', 'ì•¼ëˆ', 'ì•¼ë„ë€', 'ì½”ì¼', 'ë ˆì–´ì½”ì¼', 'íŒŒì˜¤ë¦¬', 'ë‘ë‘', 'ë‘íŠ¸ë¦¬ì˜¤', 'ì¥¬ì¥¬', 'ì¥¬ë ˆê³¤', 'ì§ˆí½ì´', 'ì§ˆë»ê¸°', 'ì…€ëŸ¬', 'íŒŒë¥´ì…€', 'ê³ ìŠ¤', 'ê³ ìš°ìŠ¤íŠ¸', 'íŒ¬í…€', 'ë¡±ìŠ¤í†¤', 'ìŠ¬ë¦¬í”„', 'ìŠ¬ë¦¬í¼', 'í¬ë©', 'í‚¹í¬ë©', 'ì°Œë¦¬ë¦¬ê³µ', 'ë¶ë³¼', 'ì•„ë¼ë¦¬', 'ë‚˜ì‹œ', 'íƒ•êµ¬ë¦¬', 'í……êµ¬ë¦¬', 'ì‹œë¼ì†Œëª¬', 'í™ìˆ˜ëª¬', 'ë‚´ë£¨ë¯¸', 'ë˜ê°€ìŠ¤', 'ë˜ë„ê°€ìŠ¤', 'ë¿”ì¹´ë…¸', 'ì½”ë¿Œë¦¬', 'ëŸ­í‚¤', 'ë©ì¿ ë¦¬', 'ìº¥ì¹´', 'ì˜ë“œë¼', 'ì‹œë“œë¼', 'ì½˜ì¹˜', 'ì™•ì½˜ì¹˜', 'ë³„ê°€ì‚¬ë¦¬', 'ì•„ì¿ ìŠ¤íƒ€', 'ë§ˆì„ë§¨', 'ìŠ¤ë¼í¬', 'ë£¨ì£¼ë¼', 'ì—ë ˆë¸Œ', 'ë§ˆê·¸ë§ˆ', 'ì˜ì‚¬ì´ì €', 'ì¼„íƒ€ë¡œìŠ¤', 'ì‰ì–´í‚¹', 'ê°¸ë¼ë„ìŠ¤', 'ë¼í”„ë¼ìŠ¤', 'ë©”íƒ€ëª½', 'ì´ë¸Œì´', 'ìƒ¤ë¯¸ë“œ', 'ìƒ¤ë¯¸ë“œ', 'ì¥¬í”¼ì¬ë”', 'ë¶€ìŠ¤í„°', 'í´ë¦¬ê³¤', 'ì•”ë‚˜ì´íŠ¸', 'ì•”ìŠ¤íƒ€', 'íˆ¬êµ¬', 'íˆ¬êµ¬í‘¸ìŠ¤', 'í”„í…Œë¼', 'ì ë§Œë³´', 'í”„ë¦¬ì ¸', 'ì¬ë”', 'íŒŒì´ì–´', 'ë¯¸ë‡½', 'ì‹ ë£¡', 'ë§ë‚˜ë‡½', 'ë®¤ì¸ ', 'ë®¤'];
        const bossIds = [94, 130, 59, 65, 68, 3, 6, 9, 149, 144, 145, 146, 151, 143, 150];

        function getPkType(id) {
            const electric=[25,26,81,82,100,101,125,135,145], fire=[4,5,6,37,38,58,59,77,78,126,136,146], water=[7,8,9,54,55,60,61,62,72,73,79,80,86,87,90,91,98,99,116,117,118,119,120,121,129,130,131,134], grass=[1,2,3,43,44,45,46,47,69,70,71,102,103,114];
            if(electric.includes(id)) return {name:'ì „ê¸°', color:'#fff700'}; if(fire.includes(id)) return {name:'ë¶ˆê½ƒ', color:'#ff4400'}; if(water.includes(id)) return {name:'ë¬¼', color:'#0088ff'}; if(grass.includes(id)) return {name:'í’€', color:'#22ff22'}; return {name:'ë…¸ë©€', color:'#ffffff'};
        }

        let availableIds = Array.from({length: 151}, (_, i) => i + 1);
        function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        shuffle(availableIds);

        const img = { bg: new Image(), player: new Image(), boss: new Image(), eImg: [new Image(), new Image(), new Image()], item: new Image() };
        img.bg.src = 'PIC1.png'; img.player.src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png';
        img.eImg[0].src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/92.png'; img.eImg[1].src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/93.png'; img.eImg[2].src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/94.png';
        img.item.src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';

        let player = { x: 275, y: 500, pwr: 1, type: getPkType(25), inv: 0 };
        let enemies = [], bullets = [], eBullets = [], items = [], keys = {}, score = 0, gameActive = false, lastRescue = 0, currentStage = 1, frameCount = 0, remainingTime = 300, ballsThisStage = 0;
        let boss = { active: false, dying: false, deathTimer: 0, x: 275, y: 60, hp: 100, maxHp: 100, spd: 3, dir: 1, img: new Image(), hitBox: 100 };
        let isMuted = false, isPaused = false, animationId;
        const bgm = new Audio('BGM1.mp3'); bgm.loop = true;

        window.onkeydown = (e) => { 
            if (e.code === 'Space') e.preventDefault();
            keys[e.code] = true; 
            if (e.code === 'KeyP' && gameActive) isPaused = !isPaused;
            if (e.code === 'Space' && gameActive && !boss.dying && !isPaused) spawnBullet(); 
        };
        window.onkeyup = (e) => { keys[e.code] = false; };

        // [ì¶”ê°€] ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í†µí•©
        const addTouch = (id, key) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; if(id === 'm-fire' && gameActive && !isPaused) spawnBullet(); });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        };
        addTouch('m-up', 'KeyW'); addTouch('m-down', 'KeyS'); addTouch('m-left', 'KeyA'); addTouch('m-right', 'KeyD'); addTouch('m-fire', 'Space');

        function updateGalleryAndShowcase(id, src) {
            if (!id) return;
            const slot = document.getElementById('slot-' + id);
            if (slot) { 
                slot.innerHTML = `<img src="${src}">`; 
                slot.onclick = () => { img.player.src = src; player.type = getPkType(id); }; 
            }
            const li = document.createElement('li'); li.className = 'comp-item'; 
            li.onclick = () => { img.player.src = src; player.type = getPkType(id); }; 
            li.innerHTML = `<img src="${src}"><div class="pk-info">No.${id} ${pkNames[id-1]}</div>`;
            listEl.prepend(li);
        }

        function toggleBGM(event) { isMuted = !isMuted; const btn = document.getElementById('mute-btn'); if(isMuted) { bgm.pause(); btn.innerText = "BGM OFF"; btn.style.background = "#888"; btn.style.color = "#fff"; } else { if(gameActive) bgm.play(); btn.innerText = "BGM ON"; btn.style.background = "#ffd700"; btn.style.color = "#000"; } btn.blur(); }

        function startGame() { 
            if (animationId) cancelAnimationFrame(animationId);
            document.getElementById('overlay').style.display = 'none';
            enemies = []; bullets = []; eBullets = []; items = []; ballsThisStage = 0;
            player.x = 275; player.y = 500; player.inv = 120;
            remainingTime = 300; gameActive = true; isPaused = false;
            document.getElementById('stage-ui').innerText = 'ìŠ¤í…Œì´ì§€ ' + currentStage;
            if(!isMuted) bgm.play().catch(()=>{}); loop(); 
        }

        function spawnBullet() {
            const count = Math.min(3, player.pwr);
            for(let i=0; i<count; i++) { 
                const angle = (i - (count-1)/2) * 0.22; 
                bullets.push({x: player.x, y: player.y - 20, vx: angle * 15, vy: -14, dmg: 1, color: player.type.color}); 
            }
        }

        function loop() {
            if(!gameActive) return;
            if (isPaused) { ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, 0, 550, 600); ctx.fillStyle = "#ffd700"; ctx.font = "bold 40px Do Hyeon"; ctx.textAlign = "center"; ctx.fillText("ì¼ì‹œ ì •ì§€", 275, 280); ctx.font = "20px Do Hyeon"; ctx.fillText("'P'ë¥¼ ëˆŒëŸ¬ ì¬ê°œ", 275, 330); animationId = requestAnimationFrame(loop); return; }
            if (boss.dying) { boss.deathTimer++; if (boss.deathTimer > 60) { player.y -= 12; if (player.y < -100) { boss.active = false; boss.dying = false; clearStage(); return; } } }
            else {
                frameCount++;
                if(frameCount % 60 === 0) { remainingTime--; document.getElementById('time-ui').innerText = String(Math.floor(remainingTime / 60)).padStart(2,'0') + ':' + String(remainingTime % 60).padStart(2,'0'); if(remainingTime <= 0) gameOver(); }
                if (Math.random() < 0.02 + (currentStage * 0.005)) { enemies.push({ x: Math.random()*470+40, y: -50, spd: 2.2 + currentStage*0.3, type: Math.min(2, Math.floor(currentStage/6)), hp: Math.ceil(currentStage/1.5)*2, flash: 0 }); }
                if (keys['KeyW']) player.y -= 8; if (keys['KeyS']) player.y += 8; if (keys['KeyA']) player.x -= 8; if (keys['KeyD']) player.x += 8;
                player.x = Math.max(40, Math.min(player.x, 510)); player.y = Math.max(40, Math.min(player.y, 560));
                if (boss.active) { boss.x += boss.spd * boss.dir; if (boss.x > 440 || boss.x < 110) boss.dir *= -1; if (Math.random() < 0.05) eBullets.push({x: boss.x, y: boss.y+50, vy: 5.5 + currentStage*0.6}); }
                bullets.forEach((b, bi) => {
                    b.x += b.vx; b.y += b.vy;
                    if (boss.active && !boss.dying && Math.hypot(b.x - boss.x, b.y - boss.y) < 100) { boss.hp -= b.dmg; bullets.splice(bi, 1); if (boss.hp <= 0) { boss.dying = true; score += 10000; } }
                    enemies.forEach((en, ei) => { if (Math.hypot(b.x - en.x, b.y - en.y) < 45) { en.hp -= b.dmg; bullets.splice(bi, 1); if (en.hp <= 0) { if (Math.random() < 0.025) items.push({x: en.x, y: en.y, rot: 0}); enemies.splice(ei, 1); if (!boss.active) score += 400; } } });
                });
                if (player.inv <= 0) {
                    eBullets.forEach((eb) => { if (eb.y > 60 && Math.hypot(player.x - eb.x, player.y - eb.y) < 12) gameOver(); eb.y += eb.vy; });
                    enemies.forEach(en => { if (en.y > 60 && Math.hypot(player.x - en.x, player.y - en.y) < 12) gameOver(); en.y += en.spd; });
                } else { player.inv--; eBullets.forEach(eb => eb.y += eb.vy); enemies.forEach(en => en.y += en.spd); }
                items.forEach((it, i) => { it.y += 1.8; it.rot += 0.1; if (Math.hypot(player.x - it.x, player.y - it.y) < 40) { score += 5000; ballsThisStage++; player.pwr = Math.min(10, player.pwr + 1); items.splice(i, 1); } });
                if (!boss.active && score >= lastRescue + 1200) {
                    const id = availableIds.pop();
                    if(id) { updateGalleryAndShowcase(id, 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+id+'.png'); }
                    lastRescue += 1200; if (document.querySelectorAll('.slot img').length % 10 === 0) spawnBoss();
                }
                document.getElementById('score-ui').innerText = Math.floor(score).toLocaleString();
                document.getElementById('atk-lv').innerText = player.pwr;
            }
            ctx.clearRect(0, 0, 550, 600); if (img.bg.complete) ctx.drawImage(img.bg, 0, 0, 550, 600);
            if (boss.active) { ctx.save(); if (boss.dying) ctx.filter = 'brightness(200%)'; ctx.drawImage(boss.img, boss.x-110, boss.y-110, 220, 220); ctx.restore(); if (!boss.dying) { ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(boss.x-82, 18, 164, 12); ctx.fillStyle = "red"; ctx.fillRect(boss.x-80, 20, 160, 8); ctx.fillStyle = "lime"; ctx.fillRect(boss.x-80, 20, (boss.hp/boss.maxHp)*160, 8); } }
            eBullets.forEach(eb => { ctx.fillStyle = "#f0f"; ctx.beginPath(); ctx.arc(eb.x, eb.y, 10, 0, Math.PI*2); ctx.fill(); });
            bullets.forEach(b => { ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, 8, 0, Math.PI*2); ctx.fill(); });
            items.forEach(it => { ctx.save(); ctx.translate(it.x, it.y); ctx.rotate(it.rot); ctx.drawImage(img.item, -18, -18, 36, 36); ctx.restore(); });
            enemies.forEach(en => ctx.drawImage(img.eImg[en.type], en.x-40, en.y-40, 80, 80));
            ctx.drawImage(img.player, player.x-40, player.y-40, 80, 80);
            animationId = requestAnimationFrame(loop);
        }

        function spawnBoss() { boss.active = true; boss.hp = 100 + currentStage*150; boss.maxHp = boss.hp; boss.img.src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/' + bossIds[(currentStage-1)%bossIds.length] + '.png'; }
        function gameOver() { location.reload(); }
        function clearStage() { gameActive = false; cancelAnimationFrame(animationId); const timeBonus = remainingTime * 20; const ballBonus = ballsThisStage * 5000; score += timeBonus; document.getElementById('score-ui').innerText = Math.floor(score).toLocaleString(); document.getElementById('overlay-content').innerHTML = `<h1 style="color:#ffd700; font-size:40px;">STAGE ${currentStage} CLEAR!</h1><div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; border:1px solid gold; margin-top:10px;"><p style="color:#fff;">ì‹œê°„ ë³´ë„ˆìŠ¤: +${timeBonus.toLocaleString()}ì </p><p style="color:#fff;">ì•„ì´í…œ ë³´ë„ˆìŠ¤: +${ballBonus.toLocaleString()}ì </p><p style="color:#ffd700; font-weight:bold;">ë³´ìŠ¤ ì²˜ì¹˜ ë³´ë„ˆìŠ¤: +10,000ì  (íšë“)</p><h2 style="color:gold;">ëˆ„ì  ì´ì : ${Math.floor(score).toLocaleString()}</h2></div>`; document.getElementById('start-btn').innerText = "ë‹¤ìŒ ì§€ì—­ìœ¼ë¡œ ì§„ê²©"; document.getElementById('start-btn').onclick = () => { currentStage++; startGame(); }; document.getElementById('overlay').style.display = 'flex'; }
        window.onload = () => { updateGalleryAndShowcase(25, 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png'); };
    </script>
</body>
</html>